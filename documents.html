<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document Upload and Categorization</title>
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="/css/materialize.min.css">
    <!-- Custom CSS -->
    <style>
      body {
        background-color: #2196F3;
        color: white;
      }
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 50px;
      }
      h1 {
        font-size: 36px;
        margin-bottom: 30px;
        text-align: center;
      }
      .input-field {
        margin-top: 20px;
      }
      .btn {
        background-color: #0D47A1;
      }
      .btn:hover {
        background-color: #1565C0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Document Upload and Categorization</h1>
      <div class="row">
        <form class="col s12" action="/documents" method="post" enctype="multipart/form-data">
          <div class="file-field input-field col s12 m6">
            <div class="btn">
              <span>File</span>
              <input type="file" name="document">
            </div>
            <div class="file-path-wrapper">
              <input class="file-path validate" type="text">
            </div>
          </div>
          <div class="input-field col s12 m6">
            <select id="category" name="category">
              <option value="" disabled selected>Choose a category</option>
              <option value="Medical Records">Medical Records</option>
              <option value="Insurance Forms">Insurance Forms</option>
              <option value="Prescriptions">Prescriptions</option>
              <option value="Lab Results">Lab Results</option>
            </select>
            <label for="category">Category</label>
          </div>
          <div class="input-field col s12">
            <button class="btn waves-effect waves-light" type="submit" name="action">Upload Document</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Materialize JS -->
    <script src="/js/materialize.min.js"></script>
    <!-- Initialize Materialize Select Element -->
    <script>
      // Get select element
      const select = document.querySelector('select');
      // Initialize select element
      const selectInstance = M.FormSelect.init(select);
    </script>
  </body>
</html>

// Update and rewrite code with document upload and categorization function

const express = require('express');
const app = express();
const bodyParser = require('body-parser');
const multer = require('multer');
const path = require('path');

// Set up multer for document uploads
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/')
  },
  filename: (req, file, cb) => {
    const name = file.originalname.toLowerCase().split(' ').join('-');
    cb(null, Date.now() + '-' + name)
  }
})
const upload = multer({ storage: storage })

// Use body-parser middleware
app.use(bodyParser.urlencoded({ extended: true }));
app.use(express.static(path.join(__dirname, 'public')));

// Define routes
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'login.html'));
});

app.post('/login', (req, res) =>{
  // Get username and password from form
  const { username, password } = req.body;
  
  // Check if they are valid
  if (username === 'example' && password === 'password') {
    res.redirect('/documents');
  } else {
    res.send(`<html><body><h1>Invalid username or password</h1></body></html>`);
  }
});

app.get('/documents', (req, res) => {
  res.sendFile(path.join(__dirname, 'documents.html'));
});

// Upload document and categorize based on form data
app.post('/documents', upload.single('document'), (req, res) => {
  // Get the form information and document info
  const { category } = req.body;
  const documentName = req.file.originalname.toLowerCase().split(' ').join('-');
  const documentPath = req.file.path;
  
  // TODO: Save the document info to the EMR and categorize it
  
  // Return success message and options to upload another document or view documents
  res.send(`
    <html>
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Document Uploaded and Categorized Successfully</title>
        <!-- Materialize CSS -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
        <link rel="stylesheet" href="/css/materialize.min.css">
        <!-- Custom CSS -->
        <style>
          body {
            background-color: #2196F3;
            color: white;
          }
          .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50px;
          }
          h1 {
            font-size: 36px;
            margin-bottom: 30px;
            text-align: center;
          }
          .input-field {
            margin-top: 20px;
          }
          .btn {
            background-color: #0D47A1;
          }
          .btn:hover {
            background-color: #1565C0;
          }
        </style>
      </head>
      <body>
        <div class="container">
          <h1>Document Uploaded and Categorized Successfully</h1>
          <div class="row">
            <form class="col s12" action="/documents" method="post" enctype="multipart/form-data">
              <div class="file-field input-field col s12 m6">
                <div class="btn">
                  <span>File</span>
                  <input type="file" name="document">
                </div>
                <div class="file-path-wrapper">
                  <input class="file-path validate" type="text">
                </div>
              </div>
              <div class="input-field col s12 m6">
                <select id="category" name="category">
                  <option value="" disabled selected>Choose a category</option>
                  <option value="Medical Records">Medical Records</option>
                  <option value="Insurance Forms">Insurance Forms</option>
                  <option value="Prescriptions">Prescriptions</option>
                  <option value="Lab Results">Lab Results</option>
                </select>
                <label for="category">Category</label>
              </div>
              <div class="input-field col s12">
                <button class="btn waves-effect waves-light" type="submit" name="action">Upload another document</button>
                <a href="/view-documents" class="btn waves-effect waves-light">View Documents</a>
              </div>
            </form>
          </div>
        </div>
        <!-- Materialize JS -->
        <script src="/js/materialize.min.js"></script>
        <!-- Initialize Materialize Select Element -->
        <script>
          // Get select element
          const select = document.querySelector('select');
          // Set select value
          select.value = '${category}';
          // Initialize select element
          M.FormSelect.init(select);
        </script>
      </body>
    </html>
  `)
});

// Start server
app.listen(3000, () => console.log('Server started at http://localhost:3000/'));